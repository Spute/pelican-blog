# æ–‡ä»¶è·¯å¾„ï¼š.github/workflows/pelican.yml
# ç”¨é€”ï¼šåœ¨æ¨é€åˆ° main åˆ†æ”¯æ—¶ï¼Œè‡ªåŠ¨æ„å»º Pelican é™æ€ç½‘ç«™ï¼Œå¹¶éƒ¨ç½²åˆ° Cloudflare Pages

name: Build and Deploy Pelican

on:
  push:
    branches: [ main ]   # ğŸš€ å½“æ¨é€åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è§¦å‘æ„å»ºï¼ˆå¯æ ¹æ®éœ€è¦ä¿®æ”¹ï¼‰

jobs:
  build:
    runs-on: ubuntu-latest   # ğŸ’» ä½¿ç”¨æœ€æ–°çš„ Ubuntu ç¯å¢ƒä½œä¸ºæ„å»ºæœº
    env:
      R2_BUCKET: ${{ secrets.CF_R2_BUCKET }}           # ğŸ” ä» GitHub Secrets è¯»å– R2 Bucket åç§°
      R2_PUBLIC_URL: ${{ secrets.CF_R2_PUBLIC_URL }}   # ğŸ” ä» GitHub Secrets è¯»å– R2 å…¬å…± URL
    steps:
      # ==============================
      # 1ï¸âƒ£ æ‹‰å–é¡¹ç›®ä»£ç ï¼ˆåŒ…å«ä¸»é¢˜å­æ¨¡å—ï¼‰
      # ==============================
      - name: Checkout repository (include submodules)
        uses: actions/checkout@v4
        with:
          submodules: true     # âœ… å…³é”®ï¼šç¡®ä¿ä¸»é¢˜ï¼ˆsubmoduleï¼‰ä¸€å¹¶è¢«ä¸‹è½½
          fetch-depth: 0       # å»ºè®®å®Œæ•´æ‹‰å–åˆ†æ”¯ä¿¡æ¯ï¼ˆæœ‰äº› Pelican æ’ä»¶ä¾èµ– git ä¿¡æ¯ï¼‰

      # ==============================
      # 2ï¸âƒ£ å®‰è£… Python ç¯å¢ƒ
      # ==============================
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'  # âš™ï¸ æŒ‡å®š Python ç‰ˆæœ¬

      # ==============================
      # 3ï¸âƒ£ å®‰è£… Pelican åŠä¾èµ–
      # ==============================
      - name: Install dependencies
        run: |
          pip install pelican markdown   # âœï¸ æ ¹æ®ä½ çš„é¡¹ç›®éœ€è¦ï¼Œä¹Ÿå¯ä»¥åŠ æ’ä»¶ä¾èµ–ï¼Œæ¯”å¦‚ pelican[markdown,typogrify]

      # ==============================
      # 4ï¸âƒ£ æ„å»º Pelican é™æ€ç½‘ç«™
      # ==============================
      - name: Build site
        run: |
          pelican content -o output -s pelicanconf.py
          # â¬†ï¸
          # content/          â†’ ä½ çš„ Markdown æˆ– rst æ–‡ä»¶ç›®å½•
          # output/           â†’ Pelican ç”Ÿæˆçš„é™æ€ç½‘ç«™è¾“å‡ºç›®å½•
          # pelicanconf.py    â†’ Pelican é…ç½®æ–‡ä»¶

      # -------------------------------
      # 6ï¸âƒ£ åœ¨ GitHub Actions ä¸­å®‰è£… rclone
      # -------------------------------
      - name: Setup rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash

      # -------------------------------
      # 5ï¸âƒ£ é…ç½® rclone ä¸ R2
      # -------------------------------
      - name: Configure rclone for R2
        run: |
          cat <<EOF > ~/.config/rclone/rclone.conf
          [r2]
          type = s3
          provider = Cloudflare
          access_key_id = ${{ secrets.R2_ACCESS_KEY_ID }}
          secret_access_key = ${{ secrets.R2_SECRET_ACCESS_KEY }}
          endpoint = ${{ secrets.R2_ENDPOINT }}
          EOF

      # -------------------------------
      # 6ï¸âƒ£ åŒæ­¥ /output/static åˆ° R2
      # -------------------------------
      - name: Upload static files to R2
        run: |
          echo "â˜ï¸ åŒæ­¥é™æ€èµ„æºåˆ° R2..."
          rclone sync output/static "r2:${R2_BUCKET}/static" --progress

      # -------------------------------
      # 7ï¸âƒ£ æ›¿æ¢ HTML ä¸­ /static/ è·¯å¾„
      # -------------------------------
      - name: Replace static URLs in HTML
        run: |
          echo "ğŸ”„ æ›¿æ¢ HTML å†…çš„é™æ€èµ„æºè·¯å¾„..."
          find output -type f -name "*.html" -print0 | \
          xargs -0 sed -E -i "s|(src|href)=[\"']\/static\/|\1=\"${R2_PUBLIC_URL}/static/|g"

      # -------------------------------
      # 8ï¸âƒ£ éªŒè¯ä¸Šä¼ ç»“æœå¹¶åˆ é™¤ static
      # -------------------------------
      - name: Verify and clean up static
        run: |
          echo "ğŸ” éªŒè¯ R2 ä¸Šä¼ ..."
          if rclone check output/static "r2:${R2_BUCKET}/static" --one-way --size-only; then
            echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡ï¼Œåˆ é™¤æœ¬åœ° output/static"
            rm -rf output/static
          else
            echo "âŒ æ£€æŸ¥å¤±è´¥ï¼Œä¿ç•™æœ¬åœ°æ–‡ä»¶"
            exit 1
          fi

      # ==============================
      # 5ï¸âƒ£ éƒ¨ç½²åˆ° Cloudflare Pages
      # ==============================
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}     # ğŸ” ä» GitHub Secrets è¯»å– Cloudflare API Token
          accountId: ${{ secrets.CF_ACCOUNT_ID }}   # ğŸ” ä» GitHub Secrets è¯»å– Cloudflare Account ID
          projectName: pelican-blog                 # âš ï¸ æ›¿æ¢æˆä½ åœ¨ Cloudflare Pages çš„é¡¹ç›®å
          directory: ./output                       # ğŸŒ æŒ‡å®šè¦ä¸Šä¼ çš„é™æ€æ–‡ä»¶ç›®å½•ï¼ˆå³ Pelican è¾“å‡ºç›®å½•ï¼‰
